<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>AiSEG</title>
<body>
<script src="ccchart.js" charset="utf-8"></script>
<canvas id="main"></canvas>
<canvas id="sub"></canvas>
<script>
var chart_main = {
  "config": {
    "title": "AiSEG",
    "subTitle": "Statistics",
    "type": "bar",
    "minY": 0,
    "unit": "kW",
    "yScaleFont": "8px Arial",
    "yScaleRotate": -45,
    "roundDigit": 1,
    "useShadow": "no",
    "colorSet":
          ["#3CB000","#DDDD80","#DDA0DD","#DD8080"]
  },

  "data": [
    ["Time"],
    ["売電"],
    ["発電"],
    ["買電"],
    ["消費"]
  ]
};
var chart_sub = {
  "config": {
    "title": "詳細",
    "type": "bezi2",
    "lineWidth": 2,
    "minY": 0,
    "unit": "W",
    "yScaleFont": "8px Arial",
    "yScaleRotate": -45,
    "useShadow": "no",
    "colorSet":
          ["#DD0000","#00DD00","#DDDD00","#0000DD","#DD00DD","#00DDDD",
           "#DD8080","#80DD80","#DDDD80","#8080DD","#DD80DD","#80DDDD",
           "#808080","#DD4080","#DD8040","#40DD80","#80DD40","#DDDD40",
           "#80DD00","#DD8000","#8000DD","#DD0080","#0080DD","#00DD80"],
  },

  "data": [
     ["Time"],
     [" "]
  ]
};

var draw = function(data) {
  drawMain(data.time, data.sel, data.sol, data.buy, data.use);
  drawSub(data);
};

var drawMain = function(time, sel, sol, buy, use) {
  var that = ccchart.ops['main'];
  if (that.drawing) {
      console.log('drop data on drawing');
      return; // discard receive data on drawing
  }
  var maxY = 0;
  var push_data = function(index, value) {
    var rowTitle = that.op.data[index].shift();
    that.op.data[index].push(value * 1.0);
    if (that.op.data[index].length > 10) {
      that.op.data[index].shift();
    }
    var yy = Math.max.apply(null, that.op.data[index]);
    if (yy > maxY)
      maxY = yy;
    that.op.data[index].unshift(rowTitle);
  };
  push_data(0, time);
  push_data(1, sel);
  push_data(2, sol);
  push_data(3, buy);
  push_data(4, use);

  if (maxY <= 1)
    maxY = 1;

  var axisXLen;
  if (maxY <= 6){
    axisXLen = Math.ceil(maxY / 0.5);
    maxY = axisXLen * 0.5;
  } else {
    axisXLen = Math.ceil(maxY);
    maxY = axisXLen;
  }
  that.op.config.axisXLen = axisXLen;
  that.op.config.maxY = maxY;

  ccchart.init(that.id, that.op);
};

var subNumHistory = 30;
var subValueHistory = [];

var drawSub = function(data) {
  var that = ccchart.ops['sub'];
  if (that.drawing) {
      console.log('drop data on drawing');
      return; // discard receive data on drawing
  }
  var isEmpty = function(v) {
    return v == "-W" || v == "0W" || v == "";
  }

  if (data.names != null) {
    subValueHistory.push(data.values);
    if (subValueHistory.length > subNumHistory) {
      subValueHistory.shift();
    }
    that.op.data = [ ["Time"] ];
    var c = 1;
    var maxY = 0;
    for (var i = 0; i < data.names.length; i++) {
      var exist = 0;
      for (var j = 0; j < subValueHistory.length; j++) {
        var v = subValueHistory[j][i];
        if (!isEmpty(v)) {
          exist = 1;
          break;
        }
      }
      if (exist) {
        that.op.data[c] = [];
        that.op.data[c][0] = data.names[i];
        var offset = 0;
        if (subValueHistory.length < subNumHistory) {
          offset = subNumHistory - subValueHistory.length;
        }
        for (var j = 0; j < subValueHistory.length; j++) {
          var v = subValueHistory[j][i];
          var vv;
          if (isEmpty(v)) {
            vv = 0;
          } else {
            vv = parseInt(v.slice(0, -1));
          }
          that.op.data[c][j + 1 + offset] = vv;
          if (vv > maxY)
            maxY = vv;
        }
        for (var j = 0; j < offset; j++) {
          that.op.data[c][j + 1] = that.op.data[c][subNumHistory];
        }
        c++;
      }
    }
    var axisXLen;
    if (maxY <= 100) {
      axisXLen = 10;
      maxY = 100;
    } else if (maxY <= 300) {
      axisXLen = Math.ceil(maxY / 50);
      maxY = axisXLen * 50;
    } else {
      axisXLen = Math.ceil(maxY / 100);
      maxY = axisXLen * 100;
    }
    that.op.config.axisXLen = axisXLen;
    that.op.config.maxY = maxY;
  }

  ccchart.init(that.id, that.op);
}

var fetchMain = function () {
  var get_key = function (text, keyname) {
    var v = (text.match(new RegExp('var ' + keyname + ' = "([0-9-.]+)";')))[1];
    if (v == '-')
      v = 0;
    else
      v = parseFloat(v);
    return v;
  };
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    var data = {};
    if (req.readyState == 4 && req.status == 200) {
      var text = req.responseText;
      data.sel = 0;
      data.buy = 0;
      data.sol = 0;
      data.use = 0;
      data.time = "";
      data.names = [];
      data.values = [];
      try {
        data.sel = get_key(text, "selElecT");
        data.buy = get_key(text, "buyElecT");
        data.sol = get_key(text, "solerT");
        data.use = get_key(text, "useT");
        var date = new Date();
        //time = ("0" + date.getHours()).substr(-2) + ":" + ("0" + date.getMinutes()).substr(-2) + ":" + ("0" + date.getSeconds()).substr(-2);
      } catch (e) {
      }
      fetchSub(data, 0);
    }
  }
  req.open("GET", "PROXY_HEAD/t?v=" + parseInt((new Date).getTime()/1000), true);
  req.send();
};

var fetchSub = function (data, i) {
  var get_key = function (text, keyname) {
    return (text.match(new RegExp('javascript:parent.' + keyname + ' = "(.*)";')))[1];
  };

  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if (req.readyState == 4 && req.status == 200) {
      var text = req.responseText;
      try {
        var pageno = (text.match(/javascript:parent.pageno = ([0-9]+)/))[1];
        pageno = parseInt(pageno);
        for (var n = 0; n < 10; n++) {
          data.names[n + pageno * 10] = get_key(text, "name" + n);
          data.values[n + pageno * 10] = get_key(text, "value" + n);
        }
      } catch (e) {
      }
      if (i < 3)
        fetchSub(data, i + 1);
      else
        draw(data);
    }
  }
  req.open("GET", "PROXY_HEAD/p" + i + "?v=" + parseInt((new Date).getTime()/1000), true);
  req.send();
};

ccchart.init('main', chart_main);
ccchart.init('sub', chart_sub);

// initialize
var i;
for (i = 0; i < 10; i++) {
  draw({sel:0, sol:0, buy:0, use:0});
}

fetchMain();

var intervalID = setInterval(fetchMain, 10000);

</script>
</body>
