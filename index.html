<!DOCTYPE html>
<head>
<meta charset="utf-8">
<title>AiSEG</title>
<body>
<script src="ccchart.js" charset="utf-8"></script>
<canvas id="main"></canvas>
<canvas id="sub"></canvas>
<script>
var chart_main = {
  "config": {
    "title": "AiSEG",
    "subTitle": "Statistics",
    "type": "stacked",
    "barWidth": 12,
    "stackedBar": [ 2, 2 ],
    "minY": 0,
    "unit": "kW",
    "yScaleFont": "100 8px Arial",
    "yScaleRotate": -45,
    "roundDigit": 1,
    "useShadow": "no",
    "colorSet":
          ["#3CB000","#DDA0DD","#DDDD80","#DD8080"]
  },

  "data": [
    ["Time"],
    ["売電"],
    ["消費"],
    ["発電"],
    ["買電"]
  ]
};
var chart_sub = {
  "config": {
    "title": "詳細",
    "type": "bezi2",
    "lineWidth": 2,
    "minY": 0,
    "unit": "W",
    "hanreiFont": "100 8px 'Courier New'",
    "yScaleFont": "100 8px Arial",
    "yScaleRotate": -45,
    "useShadow": "no",
    "colorSet": [],
  },

  "data": [
     ["Time"],
     [" "]
  ]
};

var sub_color_set = [
  "#800000","#c00000","#ff0000",
  "#008000","#00c000","#00ff00",
  "#808000","#c0c000","#ffff00",
  "#000080","#0000c0","#0000ff",
  "#800080","#c000c0","#ff00ff",
  "#008080","#00c0c0","#00ffff",

  "#408000","#40c000","#40ff00",
  "#400080","#4000c0","#4000ff",
  "#804000","#c04000","#ff4000",
  "#004080","#0040c0","#0040ff",
  "#800040","#c00040","#ff0040",
  "#008040","#00c040","#00ff40",

  "#80c000","#80ff00","#c0ff00",
  "#8000c0","#8000ff","#c000ff",
  "#c08000","#ff8000","#ffc000",
  "#0080c0","#0080ff","#00c0ff",
  "#c00080","#ff0080","#ff00c0",
  "#00c080","#00ff80","#00ffc0",
];

var draw = function(data) {
  drawMain(data.time, data.sel, data.sol, data.buy, data.use);
  drawSub(data);
};

var drawMain = function(time, sell, solar, buy, use) {
  var that = ccchart.ops['main'];

  if (that.drawing) {
      console.log('drop data on drawing');
      return; // discard receive data on drawing
  }
  var maxY = 0;
  var push_data = function(index, value) {
    var rowTitle = that.op.data[index].shift();
    that.op.data[index].push(value * 1.0);
    if (that.op.data[index].length > 10) {
      that.op.data[index].shift();
    }
    var yy = Math.max.apply(null, that.op.data[index]);
    if (yy > maxY)
      maxY = yy;
    that.op.data[index].unshift(rowTitle);
  };
  push_data(0, time);
  push_data(1, sell);
  push_data(2, use);
  push_data(3, solar);
  push_data(4, buy);

  for (var i = 1; i < that.op.data[1].length; i++) {
    var y0 = that.op.data[1][i] + that.op.data[2][i];
    var y1 = that.op.data[3][i] + that.op.data[4][i];
    if (y0 < y1)
      y0 = y1;
    if (y0 > maxY)
      maxY = y0;
  }

  if (maxY <= 1)
    maxY = 1;

  var axisXLen;
  if (maxY <= 6){
    axisXLen = Math.ceil(maxY / 0.5);
    maxY = axisXLen * 0.5;
  } else {
    axisXLen = Math.ceil(maxY);
    maxY = axisXLen;
  }
  that.op.config.axisXLen = axisXLen;
  that.op.config.maxY = maxY;

  ccchart.init(that.id, that.op);
};

var subNumHistory = 30;
var subValueHistory = [];

var drawSub = function(data) {
  var that = ccchart.ops['sub'];
  if (that.drawing) {
      console.log('drop data on drawing');
      return; // discard receive data on drawing
  }
  var isZero = function(v) {
    return v == "-W" || v == "0W" || v == "";
  }

  if (data.names != null) {
    var myValues = [];
    for (var i = 0; i < data.names.length; i++) {
      var v = data.values[i];
      if (isZero(v))
        myValues[i] = 0;
      else
        myValues[i] = parseInt(v.slice(0, -1));
    }

    subValueHistory.push(myValues);

    var emptyLength = 0;
    if (subValueHistory.length > subNumHistory) {
      subValueHistory.shift();
    } else {
      emptyLength = subNumHistory - subValueHistory.length;
    }

    that.op.data = [ ["Time"] ];

    var values = [];
    var c = 0;
    var maxY = 0;
    for (var i = 0; i < data.names.length; i++) {
      var exist = 0;
      for (var j = 0; j < subValueHistory.length; j++) {
        var v = subValueHistory[j][i];
        if (v != 0) {
          exist = 1;
          break;
        }
      }
      if (exist) {
        values[c] = {};
        values[c].data = [];
        values[c].data[0] = data.names[i];
        for (var j = 0; j < subValueHistory.length; j++) {
          var vv = subValueHistory[j][i];
          values[c].data[emptyLength + 1 + j] = vv;
          if (vv > maxY)
            maxY = vv;
        }
        if (emptyLength != 0) {
          values[c].data[emptyLength] = values[c].data[emptyLength + 1];
        }
        values[c].color = sub_color_set[i];
        that.op.config.colorSet[c] = sub_color_set[i];
        c++;
      }
    }
    if (values.length > 0) {
      values.sort(function(a, b) { return a.data[subNumHistory] > b.data[subNumHistory] ? 1 : -1; });
    }
    for (var i = 0; i < values.length; i++) {
      values[i].data[0] = ("    " + values[i].data[subNumHistory]).slice(-4) + "W " + values[i].data[0];
      that.op.data[i + 1] = values[i].data;
      that.op.config.colorSet[i] = values[i].color;
    }

    var axisXLen;
    if (maxY <= 100) {
      axisXLen = 10;
      maxY = 100;
    } else if (maxY <= 300) {
      axisXLen = Math.ceil(maxY / 50);
      maxY = Math.ceil(axisXLen * 50);
    } else {
      axisXLen = Math.ceil(maxY / 100);
      maxY = Math.ceil(axisXLen * 100);
    }
    that.op.config.axisXLen = axisXLen;
    that.op.config.maxY = maxY;
  }

  ccchart.init(that.id, that.op);
}

var lastFetchTop = 0;

// enable watt-checker on get every 120sec (maybe stop at 180sec)
var fetchTop = function() {
  var req = new XMLHttpRequest();
  var fetchTop = parseInt((new Date).getTime() / 1000);
  if (fetchTop - lastFetchTop < 120) {
    fetchMain();
    return;
  }
  req.onreadystatechange = function() {
    if (req.readyState == 4 && req.status == 200) {
      lastFetchTop = fetchTop;
      fetchMain();
    }
  };
  req.open("GET", "PROXY_HEAD/r?v=" + fetchTop, true);
  req.send();
};

var fetchMain = function () {
  var get_key = function (text, keyname) {
    var v = (text.match(new RegExp('var ' + keyname + ' = "([0-9-.]+)";')))[1];
    if (v == '-')
      v = 0;
    else
      v = parseFloat(v);
    return v;
  };
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    var data = {};
    if (req.readyState == 4 && req.status == 200) {
      var text = req.responseText;
      data.sel = 0;
      data.buy = 0;
      data.sol = 0;
      data.use = 0;
      data.time = "";
      data.names = [];
      data.values = [];
      try {
        data.sel = get_key(text, "selElecT");
        data.buy = get_key(text, "buyElecT");
        data.sol = get_key(text, "solerT");
        data.use = get_key(text, "useT");
        var date = new Date();
        //time = ("0" + date.getHours()).substr(-2) + ":" + ("0" + date.getMinutes()).substr(-2) + ":" + ("0" + date.getSeconds()).substr(-2);
      } catch (e) {
      }
      fetchSub(data, 0);
    }
  }
  req.open("GET", "PROXY_HEAD/t?v=" + parseInt((new Date).getTime()/1000), true);
  req.send();
};

var fetchSub = function (data, i) {
  var get_key = function (text, keyname) {
    return (text.match(new RegExp('javascript:parent.' + keyname + ' = "(.*)";')))[1];
  };

  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if (req.readyState == 4 && req.status == 200) {
      var text = req.responseText;
      try {
        var pageno = (text.match(/javascript:parent.pageno = ([0-9]+)/))[1];
        pageno = parseInt(pageno);
        for (var n = 0; n < 10; n++) {
          data.names[n + pageno * 10] = get_key(text, "name" + n);
          data.values[n + pageno * 10] = get_key(text, "value" + n);
        }
      } catch (e) {
      }
      if (i < 3)
        fetchSub(data, i + 1);
      else
        draw(data);
    }
  }
  req.open("GET", "PROXY_HEAD/p" + i + "?v=" + parseInt((new Date).getTime()/1000), true);
  req.send();
};

ccchart.init('main', chart_main);
ccchart.init('sub', chart_sub);

// initialize
var i;
for (i = 0; i < 10; i++) {
  draw({sel:0, sol:0, buy:0, use:0});
}

fetchTop();

var intervalID = setInterval(fetchTop, 10000);

</script>
</body>
